{# src/NTE/AgathoklesBundle/Resources/views/Default/index.html.twig #}

{% extends "NTEAgathoklesBundle:Default:layout.html.twig" %}

{% block agathokles_content %}
<div class="container-fluid sans-bord">
    <div>
        <link rel="stylesheet" href="//code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css">
        <script src="//code.jquery.com/jquery-1.10.2.js"></script>
        <script src="//code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
        <style>
            #map {
                height: 600px;
            }
            #control {
                position: absolute;
                top: 250px;
                left: 10px;
                width: 200px;
                height: 300px;
                background: #fff;
                border-radius: 4px;
                background-clip: padding-box;
                border: 2px solid rgba(0, 0, 0, 0.2);
                padding: 10px;
            }
            #slider-range {
                margin-left: 20px;
                height: 240px;
            }
        </style>
        <div id="map"></div>

        <script src="{{ asset('bundles/nteagathokles/js//leafletjs/leaflet.js') }}" type="text/javascript"></script>

        <link rel="stylesheet" href="http://leaflet.github.io/Leaflet.markercluster/dist/MarkerCluster.css" />
        <link rel="stylesheet" href="http://leaflet.github.io/Leaflet.markercluster/dist/MarkerCluster.Default.css" />
        <script src="http://leaflet.github.io/Leaflet.markercluster/dist/leaflet.markercluster-src.js"></script>

        <script type="text/javascript">

//                    alert( $('body').height() );
            $('#map').height( $('body').height() - $('#webpage2').height() - $('.navbar-default').height() );

            var lat;
            var lng;
            var marker;

            var amphoreIcon = L.icon({
                iconUrl: '{{ asset('bundles/nteagathokles/js/leafletjs/') }}images/marker_amphore.png',
                iconRetinaUrl: '{{ asset('bundles/nteagathokles/js/leafletjs/') }}images/marker_amphore-2x.png',
                shadowUrl: '{{ asset('bundles/nteagathokles/js/leafletjs/') }}images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor:   [12, 40],
                popupAnchor:  [1, -45],
            });

            var default_zoom = 5;
            if ( 980 > $('body').width() ) { default_zoom = 4 }
            if ( 600 > $('body').width() ) { default_zoom = 3 }

            var map = L.map('map', {attributionControl: true}).setView([42.5, 20.6], default_zoom);
            map.setMaxBounds([[59.689926, -9.239258], [20.363882, 46.538086]]);

            tileLayer = L.tileLayer('{{ asset('bundles/nteagathokles/maps') }}/{z}/{x}/{y}.png', {
                maxZoom: 8,
                minZoom: 3,
                attribution: 'Carte: OpenStreetMap MapQuest, données <strong>Agathokles/<a href="http://www.unifr.ch">UniFR</a></strong>',
            });
            tileLayer.addTo(map);

            $( document ).ready(function() {

                var markers = new L.MarkerClusterGroup({ disableClusteringAtZoom: 8, maxClusterRadius: 40, singleMarkerMode: true });

                {% for pt in lieux %}
                marker = L.marker([{{ pt.lat }}, {{ pt.lng }}], {icon : amphoreIcon});
                marker.bindPopup("<h3>{{ pt.nom }} <sup><span class=\"badge\">{{ pt.fiches|length }}</span></sup></h3>{% for timbre in pt.fiches|slice(0, 5) %}<a href=\"{{ path('fiche', { 'id': timbre.id }) }}\"><span class=\"glyphicon glyphicon-chevron-right\" aria-hidden=\"true\"></span> {{ timbre.codeType }}</a><br />{% endfor %}<br /><br /><a href=\"{{ path('lieu_show', { 'id': pt.id }) }}\" class=\"btn btn-primary\">Voir tous les timbres de ce lieu</a>.<br /><br />");
                //marker.addTo(map);
                markers.addLayer(marker);
                {% endfor %}

                map.addLayer(markers);

                // controle des layers via bouton externe
                $("#groupA").click(function(event) {
                    event.preventDefault();
                    if(map.hasLayer(groupA)) {
                        map.removeLayer(eval('groupA'));
                    } else {
                        map.addLayer(eval('groupA'));
                   }
                });

                $(function() {
                    $( "#slider-range" ).slider({
                        orientation: "vertical",
                        range: true,
                        min: -310,
                        max: -1,
                        values: [ -310, -1 ],
                        slide: function( event, ui ) {
                            $( "#daterange" ).html( "Datées de " + ui.values[ 0 ] + " à " + ui.values[ 1 ] );
                            if( ui.values[ 0 ] > -250 ) {
                                map.removeLayer(m1);
                                map.removeLayer(groupA);
                                map.removeLayer(m01);
                            } else {
                                map.addLayer(m1);
                                map.addLayer(groupA);
                                map.addLayer(m01);
                           }
                            if( ui.values[ 0 ] > -150 ) {
                                map.removeLayer(groupA);
                                map.removeLayer(markers);
                            } else {
                                map.addLayer(groupA);
                                map.addLayer(markers);
                           }
                        }
                    });
                    $( "#daterange" ).html( "Datées de " + $( "#slider-range" ).slider( "values", 0 ) +
                    " à " + $( "#slider-range" ).slider( "values", 1 ) );
                });
            });

        </script>
    </div>
</div>
{% endblock %}

{% block footer %}
{% endblock %}
